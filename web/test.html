<!DOCTYPE html>
<html>
<head>
	<title>Bootstrap 101 Template</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link href="/css/bootstrap.css" rel="stylesheet">
	<link href="/css/test.css" rel="stylesheet">
	<link href="/css/bootstrap-responsive.css" rel="stylesheet">
</head>
<body>
<div class="container-fluid">
	<div class="row-fluid">
		<div class="span12">

    		<h1>JS Test for API</h1>
	    	<div class="row-fluid">
	  			<div class="span7 ">
	  				<h2>Тестируем API:</h2>
					<div class="accordion" id="accordion2">
						<div class="accordion-group">
							<div class="accordion-heading">
								<a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapseFranchise">
								Сеть <span class="label label-success">Готово</span>
								</a>
							</div>
							<div id="collapseFranchise" class="accordion-body collapse in">
								<div class="accordion-inner">

									<ul class="nav nav-tabs">
										<li class="active"><a href="#list_franchise">GET LIST</a></li>
										<li><a href="#show_one_franchise">SHOW ONE</a></li>
										<li><a href="#create_franchise">CREATE</a></li>
										<li><a href="#update_franchise">UPDATE</a></li>
										<li><a href="#delete_franchise">DELETE</a></li>
									</ul>
									 
									<div class="tab-content">
										<div class="tab-pane active get_list" id="list_franchise">

											<form class="form-horizontal">
  												<div class="control-group">
													<label class="control-label">URL:</label>
													<div class="controls">
														<input type="text" class="url" disabled="disabled" value="/franchise" />
													</div>
												</div>


  												<div class="control-group">
													<label class="control-label">METHOD:</label>
													<div class="controls">
														<input type="text" class="method" disabled="disabled" value="GET" />
													</div>
												</div>


												<div class="control-group">
													<div class="controls">
														<span class="btn send" data-section="list_franchise">Выполнить</span>
													</div>
												</div>
											</form>
										</div>
										<div class="tab-pane show_one" id="show_one_franchise">

											<form class="form-horizontal">
  												<div class="control-group">
													<label class="control-label">URL:</label>
													<div class="controls">
														<input type="text" class="url" disabled="disabled" value="/franchise/1" />
													</div>
												</div>

  												<div class="control-group">
													<label class="control-label">METHOD:</label>
													<div class="controls">
														<input type="text" class="method" disabled="disabled" value="GET" />
													</div>
												</div>

  												<div class="control-group">
													<label class="control-label">ID:</label>
													<div class="controls">
														<input type="text" class="id" data-section="show_one_franchise" data-url="franchise" value="1" />
													</div>
												</div>

												<div class="control-group">
													<div class="controls">
														<span class="btn send" data-section="show_one_franchise">Выполнить</span>
													</div>
												</div>
											</form>
										</div>
										<div class="tab-pane create" id="create_franchise">
											<form class="form-horizontal">
  												<div class="control-group">
													<label class="control-label">URL:</label>
													<div class="controls">
														<input type="text" class="url" disabled="disabled" value="/franchise/" />
													</div>
												</div>

  												<div class="control-group">
													<label class="control-label">METHOD:</label>
													<div class="controls">
														<input type="text" class="method" disabled="disabled" value="POST" />
													</div>
												</div>

  												<div class="control-group">
													<label class="control-label">Лого:</label>
													<div class="controls">
														<input type="text" name="franchise[logo]" required="required" maxlength="100" class="logo param" />
														<span class="help-inline">franchise[logo]</span>
													</div>
												</div>

  												<div class="control-group">
													<label class="control-label">Бренд*:</label>
													<div class="controls">
														<input type="text" name="franchise[brand]" required="required" maxlength="100" class="brand param" />
														<span class="help-inline">franchise[brand]</span>
													</div>
												</div>
													
												<div class="control-group">
													<label class="control-label">Индустрия*:</label>
													<div class="controls">
														<input type="text" name="franchise[industry]" required="required" maxlength="100" class="industry param" />
														<span class="help-inline">franchise[industry]</span>
													</div>
												</div>

												<div class="control-group">
													<div class="controls">
														<span class="btn send" data-section="create_franchise">Выполнить</span>
													</div>
												</div>
											</form>
										</div>
										<div class="tab-pane update" id="update_franchise">
											<form class="form-horizontal">
  												<div class="control-group">
													<label class="control-label">URL:</label>
													<div class="controls">
														<input type="text" class="url" disabled="disabled" value="/franchise/1" />
													</div>
												</div>

  												<div class="control-group">
													<label class="control-label">METHOD:</label>
													<div class="controls">
														<input type="text" class="method" disabled="disabled" value="PUT" />
													</div>
												</div>

  												<div class="control-group">
													<label class="control-label">ID:</label>
													<div class="controls">
														<input type="text" class="id" name="id"  data-section="update_franchise" data-url="franchise" value="1" />
													</div>
												</div>

  												<div class="control-group">
													<label class="control-label">Лого:</label>
													<div class="controls">
														<input type="text" name="franchise[logo]" required="required" maxlength="100" class="param" />
														<span class="help-inline">franchise[logo]</span>
													</div>
												</div>

  												<div class="control-group">
													<label class="control-label">Бренд*:</label>
													<div class="controls">
														<input type="text" name="franchise[brand]" required="required" maxlength="100" class="param" />
														<span class="help-inline">franchise[brand]</span>
													</div>
												</div>
													
												<div class="control-group">
													<label class="control-label">Индустрия*:</label>
													<div class="controls">
														<input type="text" name="franchise[industry]" required="required" maxlength="100" class="param" />
														<span class="help-inline">franchise[industry]</span>
													</div>
												</div>

												<div class="control-group">
													<div class="controls">
														<span class="btn send" data-section="update_franchise">Выполнить</span>
													</div>
												</div>
											</form>
										</div>
										<div class="tab-pane delete" id="delete_franchise">
											<form class="form-horizontal">
												<div class="control-group">
													<label class="control-label">URL:</label>
													<div class="controls">
														<input type="text" class="url" disabled="disabled" id="show_one_franchise" value="/franchise/1" />
	  												</div>
	  											</div>

												<div class="control-group">
													<label class="control-label">METHOD:</label>
													<div class="controls">
														<input type="text" class="method" disabled="disabled" value="DELETE" />
													</div>
												</div>

												<div class="control-group">
													<label class="control-label">ID:</label>
													<div class="controls">
														<input type="text"  data-section="delete_franchise" data-url="franchise" class="id" value="1" />
													</div>
												</div>

												<div class="control-group">
													<div class="controls">
														<span class="btn send" data-section="delete_franchise">Выполнить</span>
													</div>
												</div>
											</form>
										</div>
									</div>
								</div>
							</div>
						</div>
						<div class="accordion-group">
							<div class="accordion-heading">
								<a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapsePoint">
								Точки <span class="label label-success">Готово</span>
								</a>
							</div>
							<div id="collapsePoint" class="accordion-body collapse">
								<div class="accordion-inner">

									<ul class="nav nav-tabs">
										<li class="active"><a href="#get_points">GET LIST</a></li>
										<li><a href="#get_near_points">GET NEAR POINTS</a></li>
										<li><a href="#show_one_point">SHOW ONE</a></li>
										<li><a href="#create_point">CREATE</a></li>
										<li><a href="#update_point">UPDATE</a></li>
										<li><a href="#delete_point">DELETE</a></li>
									</ul>
									 
									<div class="tab-content">
										<div class="tab-pane active get_list" id="get_points">

											<form class="form-horizontal">
  												<div class="control-group">
													<label class="control-label">URL:</label>
													<div class="controls">
														<input type="text" class="url" disabled="disabled" value="/point" />
													</div>
												</div>

  												<div class="control-group">
													<label class="control-label">METHOD:</label>
													<div class="controls">
														<input type="text" class="method" disabled="disabled" value="GET" />
													</div>
												</div>

												<div class="control-group">
													<div class="controls">
														<span class="btn send" data-section="get_points">Выполнить</span>
													</div>
												</div>
											</form>
										</div>
										<div class="tab-pane get_near_points" id="get_near_points">

											<form class="form-horizontal">

  												<div class="control-group">
  													<div class="controls">
  														<p>для теста мы на станции метро Белорусская</p>
  													</div>
  												</div>

  												<div class="control-group">
													<label class="control-label">Посмотреть на карте:</label>
													<div class="controls">
														<a href="http://maps.yandex.ru/?text=55.776692,37.585857" class="btn" target="_blank">http://maps.yandex.ru/?text=55.776692,37.585857</a>
													</div>
												</div>

  												<div class="control-group">
													<label class="control-label">URL:</label>
													<div class="controls">
														<input type="text" class="url input-xlarge" disabled="disabled" value="/point/55.776692x37.585857/1000" />
													</div>
												</div>

  												<div class="control-group">
													<label class="control-label">METHOD:</label>
													<div class="controls">
														<input type="text" class="method" disabled="disabled" value="GET" />
													</div>
												</div>

  												<div class="control-group">
													<label class="control-label">Широта x Долгота:</label>
													<div class="controls">
														<input type="text" class="latitude_point input-small" value="55.776692" /> x
														<input type="text" class="longitude_point input-small" value="37.585857" />
													</div>
												</div>

  												<div class="control-group">
													<label class="control-label">В радиусе:</label>
													<div class="controls">
														<input type="text" class="distance_point" value="1000" />
													</div>
												</div>

												<div class="control-group">
													<div class="controls">
														<span class="btn send" data-section="get_near_points">Выполнить</span>
													</div>
												</div>
											</form>
										</div>
										<div class="tab-pane show_one" id="show_one_point">

											<form class="form-horizontal">
  												<div class="control-group">
													<label class="control-label">URL:</label>
													<div class="controls">
														<input type="text" class="url" disabled="disabled" value="/point/1" />
													</div>
												</div>

  												<div class="control-group">
													<label class="control-label">METHOD:</label>
													<div class="controls">
														<input type="text" class="method" disabled="disabled" value="GET" />
													</div>
												</div>

  												<div class="control-group">
													<label class="control-label">ID:</label>
													<div class="controls">
														<input type="text" class="id" data-section="show_one_point" data-url="point" value="1" />
													</div>
												</div>

												<div class="control-group">
													<div class="controls">
														<span class="btn send" data-section="show_one_point">Выполнить</span>
													</div>
												</div>
											</form>
										</div>
										<div class="tab-pane create" id="create_point">
											<form class="form-horizontal">
  												<div class="control-group">
													<label class="control-label">URL:</label>
													<div class="controls">
														<input type="text" class="url" disabled="disabled" value="/point/" />
													</div>
												</div>

  												<div class="control-group">
													<label class="control-label">METHOD:</label>
													<div class="controls">
														<input type="text" class="method" disabled="disabled" value="POST" />
													</div>
												</div>

  												<div class="control-group">
													<label class="control-label">Название*:</label>
													<div class="controls">
														<input type="text" name="point[title]" required="required" maxlength="100" class="latitude param" />
														<span class="help-inline">point[title]</span>
													</div>
												</div>

												<div class="control-group">
													<label class="control-label">Описание(время работы)*:</label>

													<div class="controls">
														<textarea name="point[description]" required="required" class="description param"></textarea>
														<span class="help-inline">point[description]</span>
													</div>
												</div>

  												<div class="control-group">
													<label class="control-label">Активность*:</label>

													<div class="controls">
														<label class="checkbox inline my_width">
														  <input type="checkbox" name="point[active]" class="param" value="1" checked>
														  Точка активна
														</label>
														<span class="help-inline">point[active]</span>
													</div>
												</div>

  												<div class="control-group">
													<label class="control-label">Широта*:</label>
													<div class="controls">
														<input type="text" name="point[latitude]" required="required" maxlength="12" class="param" />
														<span class="help-inline">point[latitude]</span>
													</div>
												</div>
													
												<div class="control-group">
													<label class="control-label">Долгота*:</label>
													<div class="controls">
														<input type="text" name="point[longitude]" required="required" maxlength="12" class="param" />
														<span class="help-inline">point[longitude]</span>
													</div>
												</div>
													
												<div class="control-group">
													<label class="control-label">Сеть*:</label>
													<div class="controls">
														<input type="text" name="point[franchise]" required="required" maxlength="100" class="param" />
														<span class="help-inline">point[franchise]</span>
													</div>
												</div>

												<div class="control-group">
													<div class="controls">
														<span class="btn send" data-section="create_point">Выполнить</span>
													</div>
												</div>
											</form>
										</div>
										<div class="tab-pane update" id="update_point">
											<form class="form-horizontal">
  												<div class="control-group">
													<label class="control-label">URL:</label>
													<div class="controls">
														<input type="text" class="url" disabled="disabled" value="/point/1" />
													</div>
												</div>

  												<div class="control-group">
													<label class="control-label">METHOD:</label>
													<div class="controls">
														<input type="text" class="method" disabled="disabled" value="PUT" />
													</div>
												</div>

  												<div class="control-group">
													<label class="control-label">ID:</label>
													<div class="controls">
														<input type="text" class="id"  data-section="update_point" data-url="point" name="id" value="1" />
													</div>
												</div>

  												<div class="control-group">
													<label class="control-label">Название*:</label>
													<div class="controls">
														<input type="text" name="point[title]" required="required" maxlength="100" class="latitude param" />
														<span class="help-inline">point[title]</span>
													</div>
												</div>

  												<div class="control-group">
													<label class="control-label">Описание(время работы)*:</label>

													<div class="controls">
														<textarea name="point[description]" required="required" class="description param"></textarea>
														<span class="help-inline">point[description]</span>
													</div>
												</div>

  												<div class="control-group">
													<label class="control-label">Активность*:</label>

													<div class="controls">
														<label class="checkbox inline my_width">
														  <input type="checkbox" name="point[active]" class="param" value="1" checked>
														  Точка активна
														</label>
														<span class="help-inline">point[active]</span>
													</div>
												</div>

  												<div class="control-group">
													<label class="control-label">Широта*:</label>
													<div class="controls">
														<input type="text" name="point[latitude]" required="required" maxlength="12" class="param" />
														<span class="help-inline">point[latitude]</span>
													</div>
												</div>
													
												<div class="control-group">
													<label class="control-label">Долгота*:</label>
													<div class="controls">
														<input type="text" name="point[longitude]" required="required" maxlength="12" class="param" />
														<span class="help-inline">point[longitude]</span>
													</div>
												</div>
													
												<div class="control-group">
													<label class="control-label">Сеть*:</label>
													<div class="controls">
														<input type="text" name="point[franchise]" required="required" maxlength="100" class="param" />
														<span class="help-inline">point[franchise]</span>
													</div>
												</div>

												<div class="control-group">
													<div class="controls">
														<span class="btn send" data-section="update_point">Выполнить</span>
													</div>
												</div>
											</form>
										</div>
										<div class="tab-pane delete" id="delete_point">
											<form class="form-horizontal">
												<div class="control-group">
													<label class="control-label">URL:</label>
													<div class="controls">
														<input type="text" class="url" disabled="disabled" value="/point/1" />
	  												</div>
	  											</div>

												<div class="control-group">
													<label class="control-label">METHOD:</label>
													<div class="controls">
														<input type="text" class="method" disabled="disabled" value="DELETE" />
													</div>
												</div>

												<div class="control-group">
													<label class="control-label">ID:</label>
													<div class="controls">
														<input type="text" data-section="delete_point" data-url="point" class="id" value="1" />
													</div>
												</div>

												<div class="control-group">
													<div class="controls">
														<span class="btn send" data-section="delete_point">Выполнить</span>
													</div>
												</div>
											</form>
										</div>
									</div>
								</div>
							</div>
						</div>
						<div class="accordion-group">
							<div class="accordion-heading">
								<a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapseMission">
								Задания <span class="label label-warning">В процессе</span> 
								</a>
							</div>
							<div id="collapseMission" class="accordion-body collapse">
								<div class="accordion-inner">

									<ul class="nav nav-tabs">
										<li class="active"><a href="#get_list">GET LIST</a></li>
										<li><a href="#show_one">SHOW ONE</a></li>
										<li><a href="#create">CREATE</a></li>
										<li><a href="#update">UPDATE</a></li>
										<li><a href="#delete">DELETE</a></li>
									</ul>
									 
									<div class="tab-content">
										<div class="tab-pane active" id="get_list">
											<label>URL</label>
											<input type="text" class="url" value="/mission" />
											<span class="btn send">Выполнить</span>
										</div>
										<div class="tab-pane" id="show_one">
											<label>URL</label>
											<input type="text" class="url" disabled="disabled" id="show_one_mission" value="/mission/1" />
											<input type="text" value="1" />
											<span class="btn send">Выполнить</span>
										</div>
										<div class="tab-pane" id="create">

										</div>
										<div class="tab-pane" id="update">update</div>
										<div class="tab-pane" id="delete">delete</div>
									</div>
								</div>
							</div>
						</div>
					</div>
	  			</div>
	  			<div class="span5">
	  				<h2>Результат</h2>
	  				<div class="row-fluid thumbnail">

	  					<div class="progress hide progress-striped active"><div class="bar" style="width: 100%;"></div></div>

	  					<h3>Заголовок:</h3>
	  					<p id="status"></p>
	  					<h3>Ответ:</h3>
	  					<pre id="response"></pre>
	  					<a class="btn btn-block clear_result">Очистить</a>
	  				</div>
	  			</div>
	  		</div>
	  	</div>
	</div>
</div>
<script src="/js/jquery.min.js"></script>
<script src="/js/underscore-min.js"></script>
<script src="/js/backbone-min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/bootstrap-tab.js"></script>
<!--<script src="/js/test.js"></script>-->	
<script>
  $(function () {

	$('.id').bind('change keyup', function() {
		$('#'+$(this).attr('data-section')+' .url').val('/'+$(this).attr('data-url')+'/'+$(this).val());
	});

	$('.latitude_point, .longitude_point, .distance_point').bind('change keyup', function() {
		$('#get_near_points .url').val('/point/'
										+parseFloat($('.latitude_point').val())
										+'x'
										+parseFloat($('.longitude_point').val())
										+'/'
										+parseInt($('.distance_point').val())
									);
	});


    $('.nav-tabs a:first').tab('show');
    $('.nav-tabs a').click(function (e) {
		e.preventDefault();
		$(this).tab('show');
	});

    $('.clear_result').click(function(){

		$('.progress').hide();
		$('#status').html('');
		$('#response').html('');
    });

	$('.send').click(function(){
		
		var id = $(this).attr('data-section'),
			data = {};

		$('.progress').show();
		$('#status, #response').html('');

		$("#"+id+" .param").each(function() {
			if ($(this).attr('type')!='checkbox' || ($(this).attr('type') =='checkbox' && $(this).attr("checked")) ){
				data[$(this).attr('name')] = $(this).val();
			}
		});

		//console.log(data);

		$.ajax({

			type: $('#'+id+' .method').val(),
			url: '/app_dev.php'+$('#'+id+' .url').val(),
			data:data

		}).done(function( a,b,c) {

			console.log( "done: ",a, b,c);
			$('.progress').hide();
			$('#status').html(c.status);
			$('#response').html(c.responseText);

		}).error(function(a,b,c){

			console.log( "error: ", a, b,c);
			$('.progress').hide();
			$('#status').html(a.status);
			$('#response').html(a.responseText);

		});
    });

  });

// универсальные табы для всех сущностей
var tabs = new Backbone.Collection([
  {title:"GET LIST",	name: "get_list",	active: 1},
  {title:"SHOW ONE",	name: "show_one",	active: 0},
  {title:"CREATE",		name: "create",		active: 0},
  {title:"UPDATE",		name: "update",		active: 0},
  {title:"DELETE",		name: "delete",		active: 0},
]);

var ControlGroupView = Backbone.View.extend({
	className: 'control-group',
	tagName: 'div',
	template: _.template(	'<label class="control-label"><%= title %>*:</label>'+
							'<div class="controls">'+
								'<textarea name="<%= entity %>[<%= param_name %>]" class="param"></textarea>'+ //<% print((required)?"required="required"":""); %>
								'<span class="help-inline"><%= entity %>[<%= param_name %>]</span>'+
							'</div>'),
	render:function(){
		var content = this.template(this.model.toJSON());
		return this;
	}
});

var TabView = Backbone.View.extend({
	tagName: 'li',
	events:{
		'click':'show'
	},
	show:function(e){
		e.preventDefault();
		//console.log(this.$el.tab('show'));
		$('a', this.$el).tab('show');
	},
	initialize:function(){
		this.render();
	},
	render:function(){
		this.$el.html('<a href="#'+this.model.get('name')+'_'+this.options.entity_name+'">'+this.model.get('title')+'</a>')
		if(this.model.get('active')){
			this.$el.addClass('active');
		}
		return this;
	}
});
var TabPane = Backbone.View.extend({
	className: 'tab-pane',
	initialize:function(){
		this.render();
	},
	render:function(){
		this.$el.html(this.model.get('name')+' - '+this.options.entity_name);
		
		this.$el.attr('id',this.model.get('name')+'_'+this.options.entity_name);
		
		if(this.model.get('active')){
			this.$el.addClass('active');
		}
		return this;
	}
});

var TabsView = Backbone.View.extend({
	className: 'nav nav-tabs',
	tagName: 'ul',
	initialize:function(){
		this.render();
	},
	render:function(){
		console.log(this);
		var entity_name = this.model.get('entityName').toLowerCase(),
			THIS = this;


		_.each(tabs.models, function(tab){
			var tabview = new TabView({model:tab, entity_name:entity_name});
			THIS.$el.append(tabview.el);
		});
		return this;
	}
});

var TabsContent = Backbone.View.extend({
	className: 'tab-content',
	initialize:function(){
		this.render();
	},
	render:function(){
		var entity_name = this.model.get('entityName').toLowerCase(),
			THIS = this;

		_.each(tabs.models, function(tab){
			var tabview = new TabPane({model:tab, entity_name:entity_name});
			THIS.$el.append(tabview.el);
		});

		return this;
	}
});

var ControlGroupModel = Backbone.Model.extend({
	defaults: {
		"required":1,
		"entity":"point",
		"param_name":"title",
		"description":"Описание",
	}
});

var EntityView = Backbone.View.extend({
	className:'accordion-group',
	template:_.template(	'<div class="accordion-heading">'+
								'<a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapse<%= entityName %>">'+
								'<%= name %>'+ //<span class="label label-success">Готово</span>
								'</a>'+
							'</div>'+
							'<div id="collapse<%= entityName %>" class="accordion-body collapse">'+
								'<div class="accordion-inner"></div>'+
							'</div>'),
	initialize:function(){	
		this.render();
	},
	render:function(){

		var content = this.template(this.model.toJSON());

		this.$el.html(content);
		this.renderTabs();
		
		return this;
	},

	renderTabs:function(){
		
		var tabsview = new TabsView({model:this.model});
		var tabscontent = new TabsContent({model:this.model});

		$('.accordion-inner', this.$el)
				.html(tabsview.el)
				.append(tabscontent.el);

		//add Tabs + TabsContent
	}

})


var Entity = Backbone.Model.extend({
	defaults:{
		name:'[неуказано]',
		type:'string',
		required:0
	},
	initialize:function(){
		this.view = new EntityView({model:this});
		$('.accordion').append(this.view.el);
	}
});

var Entities = Backbone.Collection.extend({
	model:Entity,
	initialize:function(){

	},
	reset:function(models){
		if (models.length>0){
			for (var i=0; models.length>i; i++){
				this.add(new Entity(models[i]));
			}
		}
	}
});

var collection;

$(function () {
	collection = new Entities([
		{name: "Сеть", entityName: "Franchise1",	parameters:[
													{title:'Лого',name:'logo',type:'string',required:0},
													{title:'Бренд',name:'brand',type:'string',required:1},
													{title:'Индустрия',name:'industry',type:'string',required:1}
												]
		},
		{name: "Точки", entityName: "Point1",	parameters:[
													{title:'Название',name:'title',type:'string',required:1},
													{title:'Описание(время работы)',name:'description',type:'text',required:0},
													{title:'Активность',name:'active',type:'checkbox',required:0},
													{title:'Широта',name:'latitude',type:'string',required:1},
													{title:'Долгота',name:'longitude',type:'string',required:1},
													{title:'Сеть',name:'franchise',type:'string',required:1}
												]
		},
	]);
});

</script>
</body>
</html>